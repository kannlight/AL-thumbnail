# 開発要件定義書：AL-thumbnail (画像生成チャットUI & MCPクライアント)

## 1. プロジェクト概要
ユーザーと対話し、遊戯王OCGの対戦動画用サムネイル画像を生成・修正するWebアプリケーション「AL-thumbnail」を開発します。
このアプリは、Googleの最新の画像生成モデル（Gemini API）のマルチターン対話機能を利用し、対話の文脈を維持しながら画像の生成と修正を行います。また、外部のMCPサーバーと通信してカードイラストを参照として利用します。

## 2. システム要件
* **言語/フレームワーク:** Next.js (React / TypeScript推奨)
    * ※BFF（Backend for Frontend）パターンを採用し、APIキーやMCP通信ロジックはサーバーサイド（API Route）に隠蔽すること。
* **インフラ:** Firebase Hosting (Webフレームワーク連携を利用したデプロイ)
* **認証:** アプリケーション独自の共通パスワード画面（ゲートウェイ）
* **LLM連携:** Gemini API (`gemini-3-pro-image-preview` 等の画像生成対応モデル)
    * **重要:** ステートレスな単発呼び出しではなく、**マルチターン対話（Chat Session）API**を利用して実装すること。

## 3. 機能要件
### 3-1. サイトアクセス制御（パスワードゲートウェイ）
* アプリケーションにアクセスした際、単一の「パスワード入力画面」を表示し、メイン画面へのアクセスをブロックする。
* 入力されたパスワードを検証し、正しければCookie等に保存してメインのチャット画面へ遷移させる。

### 3-2. Gemini APIとの連携（サーバーサイド処理）
* Next.jsのAPIルート側で、Gemini APIとのチャットセッションを確立・管理する。
* セッション開始時の**システムプロンプト（System Instruction）**として、以下を設定する。
    > あなたは遊戯王OCGの対戦動画サムネイルを作成するアシスタントです。
    > ユーザーの要望に応じて、必ずMCPツール（`get_theme_illustrations` または `get_card_illustration`）を使用して関連する公式カードイラストを参照し、それらを元に画像を生成してください。
* **画像生成の設定（Generation Config）:**
  YouTubeサムネイルの制限（2MB以下）を満たすため、API呼び出し時のオプションとして以下のアスペクト比と解像度（1K）を**必ず指定**すること。
  ```json
  "generationConfig": {
    "imageConfig": {
      "aspectRatio": "16:9",
      "imageSize": "1K"
    }
  }
* MCPサーバーから取得した画像データを、Gemini APIが要求する形式（インラインデータや参照URLなど）に変換して、プロンプトと共に渡す処理を実装する。

### 3-3. バックエンド(MCPサーバー)との通信
* MCPツールを呼び出す必要がある場合、APIルートからバックエンドのMCPサーバーへSSE接続を行う。
* 接続時、3-1で保存したパスワードを `Authorization: Bearer <password>` ヘッダーとして付与する。

### 3-4. チャットUI・画像機能
* ユーザーの入力と、AIからの応答（テキスト＋生成画像）が時系列で表示されるタイムライン形式のUI。
* マルチターンAPIを利用するため、ユーザーが「さっきの画像をもう少し暗くして」と入力するだけで、過去の文脈（画像を含む）を踏まえた修正が行われるように実装する。
* 生成された画像のプレビュー表示と、ダウンロード（保存）ボタンの設置。

## 4. 成果物
* Next.jsのソースコード一式
* `package.json`
* Firebaseへのデプロイ手順書